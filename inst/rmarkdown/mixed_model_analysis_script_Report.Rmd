---
title: "LFQ modelling results"
author: "FGCZ"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    includes:
      in_header: fgcz_header.html
      after_body: fgcz_footer.html
params:
  pars: NULL
bibliography: bibliography.bib

---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(flextable)
pars <- params$pars
```


- project Id : `r pars$project_Id`
- order Id : `r pars$order_Id`
- parent work-unit Id : `r pars$workunit_Id`
- modelling implemented by : `r pars$author`
- input file : `r pars$inputMQfile`


# Method [^0]


Protein fold changes were computed based on peptide intensity values reported in the MaxQuant generated `peptides.txt` file, using linear mixed-effects models [@lmer2015].
We preprocess the peptide intensities reported in the peptides.txt file as follows: we removed all proteins with only one identified peptide, we remove intensities equal zero, non zero intensities are $\log_2$ transformed and modified using robust z-score transformation (using the median and median average deviation). For each protein, we fitted a mixed-effects model to the peptide intensities. Fold changes and p-values for each contrast (see table below) are computed based on this model [@lmerTest2017]. For a contrast, all the protein p-values are adjusted for multiple testing using the Benjamini and Hochberg procedure to obtain the false discovery rate (FDR) [see @BenjaminiHochberg1995].

To estimate fold-changes for proteins for which we could not fit a mixed-effects model because of an excess in missing measurements, we proceed as follows: First, we compute the mean intensity for all peptides for each condition. For the proteins with no measurements in that condition, we impute the peptide intensities using the mean of the $10\%$ smallest average peptide intensities computed in step one. Afterwards, we compute contrasts (differences between conditions) for each peptide and finally, the median of the peptide estimates is used to provide a per protein fold change estimate.  

[^0]: This section can be used in the material and methods section alongside the model formula and the contrast specifications given below.

# Data preprocessing and diagnostic plots

A set of diagnostic plots is generated from protein intensities. The diagnostic plots (PCA, heatmaps) are generated from transformed, normalized protein intensities [^1]. 
[^1]: The peptide intensities are $\log_2$ transformed and z-scored. The protein intensity are determined using the [Tukey Median polish](https://en.wikipedia.org/wiki/Median_polish) from the transformed and scored peptide intensities.  



The raw files are annotated with the following factors and factor levels:

```{r annotation}
ftab <- flextable(pars$annotation) %>%
  autofit() %>% set_caption("Sample annotations.")
ftab

```



- [Peptide intensity vs RT plot](qc_results/retention_time_plot.png){target="_blank"}
- PCA plot ([pdf](qc_results/protein_intensities_PCA_.pdf){target="_blank"},[html](qc_results/protein_intensities_PCA_.html){target="_blank"}) showing the samples according to the first and second principal component.
- [Heatmap based on protein intensity correlation among samples](qc_results/protein_intensities_heatmap_correlation_.pdf){target="_blank"}.
- [Protein intensities heatmap](qc_results/protein_intensities_heatmap_.pdf){target="_blank"}. The columns represent samples while the rows represent proteins. The protein intensities were z scored.
- The protein intensities in [excel xlsx format](qc_results/protein_intensities_wide_.xlsx){target="_blank"}.
- A [pdf file](qc_results/protein_intensities_inference_figures.pdf){target="_blank"} visualizing all the peptide and protein intensities (the peptide intensities are $\log_2$ transformed and [z-scored](https://en.wikipedia.org/wiki/Standard_score) ). 
- A quality control report of estimated protein intensities [html](qc_results/protein_intensities_qc.html){target="_blank"}.




# Mixed Effects Model

The following mixed-effects model was fitted [see @lmer2015]: 

__`r format(formula(pars$model))`__

Using this model the following contrasts were computed. 

```{r contrasts}
Contrasts <- data.frame(contrast = names(pars$Contrasts), explicit = as.character(pars$Contrasts))
ft_contrast <- qflextable(Contrasts)
ft_contrast <- ft_contrast %>% set_caption("Contrasts (vs - versus, gv - given).")
ft_contrast
```


The p values of the ANOVA analysis and p values of the contrasts were estimated using the R package lmerTest [see @lmerTest2017].


```{r filepaths, include=FALSE}
anovaXLSX <- file.path(pars$modelling_dir, "Anova_Model")
anovaPDF <- file.path(pars$modelling_dir, "Anova_p.values_Model.pdf")
contrastXLSX <- file.path(pars$modelling_dir, "foldchange_estimates")
histogramPVal <-   file.path(pars$modelling_dir, "Contrasts_Histogram_p.value_Model")
histogramPValAdj <- file.path(pars$modelling_dir, "Contrasts_Histogram_p.value.adjusted_Model")
volcanoPVal <- file.path(pars$modelling_dir, "Contrasts_Volcano_p.value_Model")
volcanoPValAdj <- file.path(pars$modelling_dir, "Contrasts_Volcano_p.value.adjusted_Model")
maPlot <- file.path(pars$modelling_dir, "Contrasts_MA_FC_estimate_Model")
```


- ANOVA results ([excel xlsx format](`r paste0(anovaXLSX,".xlsx")`);[html](`r paste0(anovaXLSX,".html")`){target="_blank"} and histogram of p-Values [pdf](`r anovaPDF`){target="_blank"} which shows which factors in the model are most significant.

- For all contrasts and proteins:
    - A __table__ with all fold change estimates and p values ([excel xlsx format](`r paste0(contrastXLSX,".xlsx")`); [html](`r paste0(contrastXLSX,".html")`){target="_blank"}) for all proteins and contrasts. For proteins not quantified in one of the conditions, _pseudo_ estimates are provided [^2].
    - __Histogram of p-Values__ ([pdf](`r paste0(histogramPVal,".pdf")`){target="_blank"}) shows the distribution of the p-Values for each contrast. This plot can be used to asses the quality of you data and model (see [How to interpret p-value histogram]( http://varianceexplained.org/statistics/interpreting-pvalue-histogram/)).
    - __Histogram of adjusted p-Values__ ([pdf](`r paste0(histogramPValAdj,".pdf")`){target="_blank"}) shows the distribution of the false discovery rates (FDR - p values adjusted using the Benjamin and Hochberg method [see @BenjaminiHochberg1995]).
    - __Volcano plot of p-Values vs fold change estimate__ ([pdf](`r  paste0(volcanoPVal,".pdf")`){target="_blank"}; [html](`r paste0(volcanoPVal,".html")`){target="_blank"}) which on the vertical axis shows the protein $-log10(p~values)$ versus the the log2 fold changes on the horizontal axis.
    - __Volcano plot of adjusted p-Values vs fold change estimate__ ([pdf](`r paste0(volcanoPValAdj,".pdf")`){target="_blank"}; [html](`r paste0(volcanoPValAdj, ".html")`){target="_blank"})  which on the vertical axis shows the $-log10(FDR)$ versus the the _log2_ fold changes on the horizontal axis.
    - [__MA plot__](https://en.wikipedia.org/wiki/MA_plot) ([pdf](`r paste0(maPlot,".pdf")`){target="_blank"}; [html](`r paste0(maPlot, ".html")`){target="_blank"}). The vertical axis shows the contrast estimate (_log2 FC_) while the horizontal axis shows the mean of the measurments (this is also known as mean difference plot MD).
    


[^2]:  To estimate a fold-changes for proteins were a mixed-effects model can not be fitted, because there is no measurement for on of the conditions, we proceed as follows: First, we compute the mean intensity of all peptides for that condition. For the proteins with no measurements, we impute the peptide intensities using the mean of the $10\%$ smallest average peptide intensities computed in step one. 
Afterwards, we compute contrasts (differences between conditions) for each peptide and finally, the median of the peptide estimates is used to provide a per protein fold change estimate.  
