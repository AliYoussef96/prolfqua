---
title: "QC and Sample Size Estimation."
author: "Witold Wolski"
date: "14/12/2020"
output: pdf_document
vignette: >
  %\VignetteIndexEntry{QC and Sample Size Estimation.} 
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}

---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


# The LFQData API

Create configuration for MQ peptide file or use function `create_config_MQ_peptide`

```{r createConfig}
library(prolfqua)
library(tidyverse)



atable <- AnalysisTableAnnotation$new()
atable$fileName = "raw.file"
# measurement levels.
atable$hierarchy[["protein_Id"]] <- c("top_protein")
atable$hierarchy[["peptide_Id"]] <- c("sequence")
atable$hierarchyDepth <- 1
atable$ident_qValue = "pep"
atable$setWorkIntensity("peptide.intensity")
anaparam <- AnalysisParameters$new()
anaparam$min_peptides_protein <- 2
config <- AnalysisConfiguration$new(atable, anaparam)

```


```{r LoadDataAndConfigure}
datadir <- file.path(find.package("prolfquaData") , "quantdata")
inputMQfile <-  file.path(datadir, "MAXQuant_ComboCourse_p2691_March_2018_WU183012.zip")
inputAnnotation <- file.path(datadir, "annotation_ComboCourse_p2691_March_2018_WU183012.xlsx")
startdata <- prolfqua::tidyMQ_Peptides(inputMQfile)
startdata <- prolfqua::tidyMQ_top_protein_name(startdata, prot_col = "proteins")

annotation <- readxl::read_xlsx(inputAnnotation)
annotation$experiment = "p2691"

startdata <- inner_join(annotation, startdata)

config$table$factors[["condition_"]] = "condition"
config$table$factors[["batch_"]] = "experiment"
config$table$factors[["Run_ID"]] = "Run_ID"
config$table$factorDepth <- 1

adata <- setup_analysis(startdata, config)

xx <- toWideConfig(adata, config)

adata <- adata %>% filter(condition_ == "Ethanol")

```

Remove zeros from data, and filter for at least two peptides (proteins with a single peptide are dropped).

```{r filterdata}
lfqdata <- LFQData$new(adata, config)
lfqdata$remove_small_intensities()
lfqdata$config$parameter$min_peptides_protein
lfqdata$filter_proteins_by_peptide_count()

```

## Visualization of not normalized data

```{r makeMissingHeatmap}
lfqplotter <- lfqdata$get_Plotter()
lfqplotter$intensity_distribution_density()
nah <- lfqplotter$NA_heatmap()
```

```{r printMissingHeatmap}
nah
```

```{r}
lfqplotter$missingness_per_condition()
```


```{r PlotCVDistributions}
stats <- lfqdata$get_Stats()
prolfqua::table_facade( stats$stats_quantiles()$wide, paste0("quantile of ",stats$stat ))

stats$density_median()
stats$stdv_vs_mean(size = 400) + scale_x_log10() + scale_y_log10()
```

## Normalize

We normalize the data by $\log2$ transforming and then z-scaling.

```{r normalizedata}
lt <- lfqdata$get_Transformer()
transformed <- lt$log2_robscale()
transformed$config$table$is_intensity_transformed

```

```{r plotDensities}
pl <- transformed$get_Plotter()
pl$intensity_distribution_density()
```

```{r plotScatterMatrix}
transformed$get_Plotter()$pairs_smooth()
```

```{r createHeatmap}
p <- transformed$get_Plotter()$heatmap()
```

```{r plotheatmap}
p
```

There is also a function to create an heatmap based on the correlated samples.



```{r showStandardDeviations}
stats <- transformed$get_Stats()
stats$stat
prolfqua::table_facade(stats$stats_quantiles()$wide, "Standard deviations")

```


```{r sddensity, fig.cap="Density of the standard deviation"}
stats$density_median()
```

```{r experiment, include = FALSE}
chsq <- na.omit(stats$statsdf$sd^2)
plot(density(chsq[chsq < 10]))
x <- seq(0,50, length = 1000)
lines(x*median(chsq) , dchisq(x, df = 4 ), col = 2)

```

Check for heteroskedasticity. After transformation the sd should be independent of the mean intensity.

```{r checkForHeteroskedasticity, fig.cap="check if sd constant for all intensities"}
stats$stdv_vs_mean(size = 400) + scale_x_log10() + scale_y_log10()
```


## Estimate sample size for main experiment.


```{r estimateSampleSizes}
sampleSize <- stats$power_t_test_quantiles() %>% filter(condition_ != "All")
prolfqua::table_facade(sampleSize, "Sample sizes. delta - Effect size")

sampleSize %>%
  ggplot(aes(x = factor(probs) , y = N)) +
  facet_wrap(~delta) +
  geom_bar(stat = "identity")
```

Getting the sample size for all the peptides.


```{r pwerforAll, eval = FALSE}
stats$power_t_test()
```


Please note that these QC were made all on peptide level. Using the LFQDataAggregator you can estimate protein intensities. Sample sizes on protein level might be smaller.


