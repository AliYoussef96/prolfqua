---
title: "prolfqua - Proteomics Label Free Quantification"
author: "Witold Wolski"
date: "14/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Creating a configuration for a file in long data format.

Given an Normal Report Peptide Quant Report generated by Spectronaut, which is a table in long format, we are going to create Configuration which will allow us to run function in the package.
The configuration object describes the columns in the long table so that the function will know where they can find the information tey operate on.

```{r}
library(tidyverse)
library(LFQService)
file <- LFQService:::.find.package.file("LFQService","samples/spectronaut_PEPTIDE.xls")
xx <- readr::read_tsv(file)
xx <- xx %>% rename(EG.TotalQuantity = "EG.TotalQuantity (Settings)")
xx$Isotope.Label <- "light"
```

We create a Table annotation object and start annotating the data we read.

```{r}
atable <- AnalysisTableAnnotation$new()
atable$fileName = "R.FileName"
atable$ident_qValue = "EG.Qvalue"
atable$workIntensity = "EG.TotalQuantity"
atable$isotopeLabel = "Isotope.Label"

```

The columns identifying the measured features, which are proteins, peptides or precursors, are the described using the named list hierarchy. The values of the list are the column names, while the names of your list are arbitrary as long as they are valid R column names (see function `make.names`). 

The names list factors, is used to point to the columns containing the factors of you analysis.
Here we rename the column "R.Condition" to "Marker". The data.frame can contain more than one factor. 
```{r}
atable$hierarchy[["PG.ProteinAccessions"]]    <-  "PG.ProteinAccessions"
atable$hierarchy[["EG.PrecursorId"]]    <-  "EG.PrecursorId"
atable$factors[["Marker"]] <- "R.Condition"
```


Lastly, we create an Analysis parameter object, and the Analysis Configuration. The function `setup_analysis`, creates from data frame in long format a data.frame compatible with your configuration. We can now run most of the function in the package using the data and configuration.

```{r}
anaparam <- AnalysisParameters$new()
config <- AnalysisConfiguration$new(atable, anaparam)
analysis_data <- setup_analysis(xx, config)

LFQService::summarize_hierarchy(analysis_data, config)

```


# The LFQData API

peptide intensities and summarizing protein intensities

```{r filterdata}

istar <- LFQService::ionstar$Pep()
lfqdata <- LFQData$new(istar$data, istar$config)
lfqdata$remove_small_intensities()
lfqdata$config$parameter$min_peptides_protein
lfqdata$filter_proteins_by_peptide_count()

```

## Visualization of not normalized data

```{r}
lfqplotter$intensity_distribution_density()
```

```{r plotting}
lfqplotter <- lfqdata$get_Plotter()
```

```{r heatmap}
lfqplotter$heatmap()
```

```{r heatmap_cor, fig.cap = "heatmap of sample correlation"}
lfqplotter$heatmap_cor()
```

```{r heatmap_an}
lfqplotter$NA_heatmap()
```
