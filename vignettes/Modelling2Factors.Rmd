---
title: "Modelling Dataset with two Factors."
author: "Witold Wolski"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: default
  pdf_document: default
vignette: |
  %\VignetteIndexEntry{Modelling dataset with two Factors.}  
  %\VignetteEncoding{UTF-8}   
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---


# Model Fitting

```{r specifyModel}

pMerged <- prolfqua::data_Yeast2Factor
pMerged$config$table$getWorkIntensity()

formula_Batches <-
  strategy_lm("transformedIntensity ~ condition_ * batch_ ")

# specify model definition
modelName  <- "Model"
DEBUG <- TRUE

Contrasts <- c("Glucose - Ethanol" = "condition_Glucose - condition_Ethanol",
               "p2370 - p2691" = "batch_p2370 - batch_p2691",
               "Glucose_vs_Ethanol_gv_p2370" = "`condition_Glucose:batch_p2370` - `condition_Ethanol:batch_p2370`",
               "Glucose_vs_Ethanol_gv_p2691" = "`condition_Glucose:batch_p2691` - `condition_Ethanol:batch_p2691`",
               "Interaction" = "`Glucose_vs_Ethanol_gv_p2370` - `Glucose_vs_Ethanol_gv_p2691`"
)



```



```{r buildModel}


mod <- prolfqua::build_model(
  pMerged$data,
  formula_Batches,
  subject_Id = pMerged$config$table$hierarchyKeys() )

```



```{r anovaPvaluePlots, fig.cap="p-value distributions for ANOVA analysis."}
mod$anova_histogram()
```

Examine proteins with a significant interaction between the two factors treatment and batch.

```{r anovaAnalysis}
ANOVA <- mod$get_anova()
unique(ANOVA$factor)
ANOVA %>% filter(factor == "condition_:batch_") %>% arrange(FDR.Pr..F.) %>% head(5)
protIntSig <- ANOVA %>% filter(factor == "condition_:batch_") %>% filter(FDR.Pr..F. < 0.05)
protInt <-  pMerged$get_copy()
protInt$data <- protInt$data[protInt$data$protein_Id %in% protIntSig$protein_Id,]
```


```{r fig.with=15, fig.height=15}
ggpubr::ggarrange(plotlist = protInt$get_Plotter()$boxplots()$boxplot)

```

# Compute contrasts

```{r computeModeratedContrasts}
contr <- prolfqua::ContrastsModerated$new(prolfqua::Contrasts$new(mod, Contrasts))
contr$get_contrasts_sides()
contrdf <- contr$get_contrasts()
```

```{r}
plotter <- contr$get_Plotter()
plotter$volcano()
plotter$ma_plot()

```


```{r}

sigInteraction <- contrdf %>% 
  filter(contrast == "Interaction" & FDR < 0.1)
protInt <-  pMerged$get_copy()
protInt$data <- protInt$data[protInt$data$protein_Id %in% sigInteraction$protein_Id,]
hm <- protInt$get_Plotter()$heatmap()

```

```{r interactionHeatmap, fig.cap="Proteins with significant Interactions"}
hm
```


## Annalyse contrasts with missing data imputation

```{r}
contrSimple <- ContrastsSimpleImpute$new(pMerged, Contrasts)
contrdfSimple <- contrSimple$get_contrasts()
pl <- contrSimple$get_Plotter()
pl$histogram_estimate()
pl$volcano()

```

```{r}
contrSimpleMod <- ContrastsModerated$new(contrSimple)
contrdfSimpleMod <- contrSimpleMod$get_contrasts()
dim(contrdfSimple)
dim(contrdfSimpleMod)

plm <- contrSimpleMod$get_Plotter()

plm$histogram_estimate()
plm$volcano()

```

## Merge nonimputed and imputed data.

```{r}
dim(contr$get_contrasts())
dim(contrSimpleMod$get_contrasts())

```
