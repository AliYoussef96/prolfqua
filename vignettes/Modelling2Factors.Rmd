---
title: "Modelling Dataset with two Factors."
author: "Witold Wolski"
date: "06/10/2020"
output:
  pdf_document: default
  html_document: default
vignette: |
  %\VignetteIndexEntry{Modelling dataset with two Factors.}  
  %\VignetteEncoding{UTF-8}   
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
echo = FALSE,
message = FALSE,
warning = FALSE,
fig.width = 10,
fig.height = 10
)
```



```{r}
library(prolfqua)
library(tidyverse)
conflicted::conflict_prefer("filter", "dplyr")



```

# Prepare p2691 dataset

```{r}
datadir <- file.path(find.package("prolfquaData") , "quantdata")
inputMQfile <-  file.path(datadir, "MAXQuant_ComboCourse_p2691_March_2018_WU183012.zip")
inputAnnotation <- file.path(datadir, "annotation_ComboCourse_p2691_March_2018_WU183012.xlsx")
startdata <- prolfqua::tidyMQ_Peptides(inputMQfile)
annotation <- readxl::read_xlsx(inputAnnotation)
annotation$experiment = "p2691"

```

Add annotation information data to configuration and data.

```{r}
config <- prolfqua::create_config_MQ_peptide()
data <- inner_join(annotation, startdata)

config$table$factors[["condition_"]] = "condition"
config$table$factors[["batch_"]] = "experiment"
config$table$factors[["Run_ID"]] = "Run_ID"
config$table$factorDepth <- 1
```

Preprocess and normalize Data.

```{r}
adata <- setup_analysis(data, config)
adata <- filter_proteins_by_peptide_count(adata, config)$data
adata <- prolfqua::remove_small_intensities(adata,config)


p2691 <- LFQData$new(adata, config)
p2691$get_Plotter()$intensity_distribution_density()

tr <- p2691$get_Transformer()
p2691 <- tr$log2_robscale()

pl <- p2691$get_Plotter()
pl$intensity_distribution_density()
#dev.off()
pha2691 <- pl$NA_heatmap()

```

```{r fig.cap="missing value heatmap for project 2691"}
print(pha2691)
```


# Prepare p2370 dataset


```{r}
datadir <- file.path(find.package("prolfquaData") , "quantdata")
inputMQfile <-  file.path(datadir, "MAXQuant_ComboCourse_p2370_March_2017_WU183008.zip")
inputAnnotation <- file.path(datadir, "annotation_ComboCourse_p2370_March_2017_WU183008.xlsx")
startdata <- prolfqua::tidyMQ_Peptides(inputMQfile)
annotation <- readxl::read_xlsx(inputAnnotation)
annotation$experiment <- "p2370"
```

Code snipped below shows how to add annotation to the data and configuration.

```{r}
data <- inner_join(annotation, startdata)
config <- create_config_MQ_peptide()

config$table$factors[["condition_"]] = "condition"
config$table$factors[["batch_"]] = "experiment"
config$table$factors[["Run_ID"]] = "Run_ID"
config$table$factorDepth <- 1
```

```{r}
adata <- setup_analysis(data, config)
adata <- filter_proteins_by_peptide_count(adata, config)$data
adata <- prolfqua::remove_small_intensities(adata,config)

p2370 <- LFQData$new(adata, config)
p2370$get_Plotter()$intensity_distribution_density()

tr <- p2370$get_Transformer()
p2370 <- tr$log2_robscale()
pl <- p2370$get_Plotter()
ha2370 <- pl$NA_heatmap()
```

```{r, fig.cap="Intensity distribution after normalization, p2370"}
pl$intensity_distribution_density()
```

```{r, fig.cap="Heatmap of missing values p2370."}
print(ha2370)
```


# Merge both dataset

To simulate a factorial design we merge both datasets.

```{r}
outpath <- "results_modelling"
data <- bind_rows(p2691$data, p2370$data)

config <- p2691$config$clone(deep = TRUE)
config$table$factorDepth <- 2

```

## QC for merged dataset 

```{r}
pl$intensity_distribution_density()
```


```{r mergeData}
pMerged <- LFQData$new(data, config)
bb <- pMerged$complete_cases()
```

```{r examineDataAfterMerge}
pl <- pMerged$get_Plotter()
pl$sample_correlation()
ph <- pl$heatmap_cor()
pha <- pl$NA_heatmap()

```


```{r plotHeatmap ,fig.cap="sample correlation heatmap merged"}
print(ph)
```


```{r plotNAheatmap, fig.cap ="Missing data heatmap for merged data"}
print(pha)
```


```{r summarizeCounts}
su <- pMerged$get_Summariser()
su$hierarchy_counts()

```



```{r, fig.cap = "Number of Proteins or peptides per sample in merged dataset"}
su$hierarchy_counts_sample("plot")
```


##  Aggregate Protein Intensities

```{r aggregate}
pAgg <- pMerged$get_Aggregator()
prot <- pAgg$medpolish()
```

Generate diagnostic plots for Protein aggregation.

```{r createDiagnostics, fig.cap="summarize Aggration result", fig.width=8, fig.height=7}
tmp <- pAgg$plot()
ggpubr::ggarrange(plotlist =  tmp$plots[1:6])

```

```{r plotBoxplotProt}
pl <- prot$get_Plotter()
pl$heatmap()
```

```{r protBP, fig.cap="Protein level boxplots"}
bp <- pl$boxplots()
ggpubr::ggarrange(plotlist = bp$boxplot[1:6])
```

# Model Fitting

```{r specifyModel}
protdata <- pAgg$lfq_agg
protdata$config$table$getWorkIntensity()

formula_Batches <-
  make_custom_model_lm("medpolish ~ condition_ * batch_ ")

# specify model definition
modelName  <- "Model"
DEBUG <- TRUE

Contrasts <- c("Glucose - Ethanol" = "condition_Glucose - condition_Ethanol",
               "p2370 - p2691" = "batch_p2370 - batch_p2691",
               "Glucose_vs_Ethanol_gv_p2370" = "`condition_Glucose:batch_p2370` - `condition_Ethanol:batch_p2370`",
               "Glucose_vs_Ethanol_gv_p2691" = "`condition_Glucose:batch_p2691` - `condition_Ethanol:batch_p2691`",
               "Interaction" = "`Glucose_vs_Ethanol_gv_p2370` - `Glucose_vs_Ethanol_gv_p2691`"
)



```



```{r specifyModel}


mod <- prolfqua::build_model(
  protdata$data,
  formula_Batches,
  subject_Id = pAgg$lfq_agg$config$table$hierarchyKeys() )

```



```{r anovaPvaluePlots, fig.cap="p-value distributions for ANOVA analysis."}
mod$anova_histogram()
```

Examine proteins with a significant interaction between the two factors treatment and batch.

```{r anovaAnalysis}
ANOVA <- mod$get_anova()
unique(ANOVA$factor)
ANOVA %>% filter(factor == "condition_:batch_") %>% arrange(FDR.Pr..F.) %>% head(5)
protIntSig <- ANOVA %>% filter(factor == "condition_:batch_") %>% filter(FDR.Pr..F. < 0.05)
protInt <-  prot$get_copy()
protInt$data <- protInt$data[protInt$data$protein_Id %in% protIntSig$protein_Id,]
ggpubr::ggarrange(plotlist = protInt$get_Plotter()$boxplots()$boxplot)

```

# Compute contrasts

```{r}
contr <- ContrastsModerated$new(mod, Contrasts)
contr$get_contrasts_sides()
contrdf <- contr$get_contrasts()
```

```{r}
plotter <- contr$get_Plotter()
plotter$volcano()
plotter$ma_plot()
```


```{r}
sigInteraction <- contrdf %>% 
  filter(contrast == "Interaction" & FDR.moderated < 0.1)
protInt <-  prot$get_copy()
protInt$data <- protInt$data[protInt$data$protein_Id %in% sigInteraction$protein_Id,]
hm <- protInt$get_Plotter()$heatmap()

```

```{r interactionHeatmap, fig.cap="Proteins with significant Interactions"}
hm
```


# Annalyse contrasts with missing data imputation

```{r}
contrSimple <- ContrastsSimpleImpute$new(protdata, Contrasts)
contrdfSimple <- contrSimple$get_contrasts()
pl <- contrSimple$get_Plotter()
pl$histogram_estimate()

```


